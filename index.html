<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“– è–ç¶“ + AI è§£é‡‹ (Grok)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background:#f8f8f8; }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    #explainButton { font-size: 1rem; padding: 0.5rem 1.2rem; }
    #aiOutput { height: 40vh; max-height: 40vh; background:#fff; border: 1px solid #bfdbfe; }
    #bibleContent { background:#ebf5ff; border: 1px solid #bfdbfe; }
  </style>
</head>
<body class="flex flex-col h-screen">
<div class="flex-1 flex flex-col overflow-hidden">

  <!-- Bible Section -->
  <div class="p-4 shadow-md rounded-b-lg flex-shrink-0">
    <div id="loadError" class="hidden bg-red-100 text-red-700 p-2 mb-2 rounded"></div>

    <div class="flex gap-3 mb-3">
      <select id="bookSelect" class="p-2 border rounded-lg">
        <option value="">è«‹é¸æ“‡æ›¸å·</option>
      </select>
      <select id="chapterSelect" class="p-2 border rounded-lg" disabled>
        <option value="">è«‹é¸æ“‡ç« ç¯€</option>
      </select>
      <select id="verseSelect" class="p-2 border rounded-lg" disabled>
        <option value="">å…¨éƒ¨ç¶“æ–‡</option>
      </select>
    </div>

    <div class="flex justify-between mb-2">
      <button id="prevChapter" class="bg-gray-300 px-3 py-1 rounded disabled:opacity-40" disabled>ä¸Šä¸€ç« </button>
      <button id="explainButton" class="bg-gradient-to-r from-green-500 to-green-700 text-white px-4 py-2 rounded shadow" disabled>AIè§£é‡‹</button>
      <button id="nextChapter" class="bg-gray-300 px-3 py-1 rounded disabled:opacity-40" disabled>ä¸‹ä¸€ç« </button>
    </div>

    <div id="bibleContent" class="p-4 rounded-lg shadow-inner overflow-y-auto no-scrollbar text-lg leading-relaxed" style="max-height:40vh;">
      ğŸ“– è«‹å…ˆé¸æ“‡æ›¸å·å’Œç« ç¯€ä¾†é–±è®€è–ç¶“ã€‚
    </div>
  </div>

  <!-- AI Section -->
  <div class="flex-1 flex flex-col p-4 mt-2 rounded-t-lg shadow-md overflow-hidden" style="background:#f0f0f0;">
    <div id="aiOutput" class="p-3 rounded-lg shadow-inner overflow-y-auto no-scrollbar text-base"></div>
    <div id="loadingIndicator" class="hidden text-center mt-2 text-blue-600 font-medium">ğŸ¤” AI æ­£åœ¨æ€è€ƒä¸­...</div>
    <div class="text-right text-xs text-gray-500 mt-1">Powered by Grok AIè§£é‡‹å…§å®¹åªä¾›åƒè€ƒ 070825 2207</div>
  </div>
</div>

<script type="module">
const GROK_API_KEY = "xai-8QlZfYtQZBaRVhkC224npvTyWoPiDBb46CoNxVBQzsjaIO64WKZGhbGzO2oB24OWUMBhop7ooA00FfSM"; // ä½ è‡ªå·±çš„ Grok API key

const bookSelect=document.getElementById('bookSelect');
const chapterSelect=document.getElementById('chapterSelect');
const verseSelect=document.getElementById('verseSelect');
const bibleContentDiv=document.getElementById('bibleContent');
const aiOutputDiv=document.getElementById('aiOutput');
const explainButton=document.getElementById('explainButton');
const loading=document.getElementById('loadingIndicator');
const prevBtn=document.getElementById('prevChapter');
const nextBtn=document.getElementById('nextChapter');
const loadError=document.getElementById('loadError');
let bibleData={};

// è§£æ TXT
function parseBibleTXT(text){
  const lines=text.split('\n');
  const data={};
  lines.forEach(l=>{
    const m=l.match(/^(.+?)(?:\s)?(\d+):(\d+)\s(.+)$/);
    if(m){
      const[_,book,ch,vs,ct]=m;
      data[book]=data[book]||{};
      data[book][ch]=data[book][ch]||{};
      data[book][ch][vs]=`${vs} ${ct}`;
    }
  });
  return data;
}

// è¼‰å…¥è–ç¶“ TXT
async function loadBible(){
  try{
    const res=await fetch('chinese_union_trad_trad.txt');
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw=await res.text();
    bibleData=parseBibleTXT(raw);
    for(const b in bibleData){
      let o=document.createElement('option');
      o.value=b;o.textContent=b;
      bookSelect.appendChild(o);
    }
  }catch(e){
    loadError.textContent="âŒ è–ç¶“è¼‰å…¥å¤±æ•—ï¼š"+e.message;
    loadError.classList.remove('hidden');
  }
}
loadBible();

// é¸æ›¸å·
bookSelect.addEventListener('change',()=>{
  const b=bookSelect.value;
  chapterSelect.innerHTML='<option value="">è«‹é¸æ“‡ç« ç¯€</option>';
  verseSelect.innerHTML='<option value="">å…¨éƒ¨ç¶“æ–‡</option>';
  bibleContentDiv.textContent="ğŸ“– è«‹é¸æ“‡ç« ç¯€";
  verseSelect.disabled=true;
  explainButton.disabled=true;
  if(!b){chapterSelect.disabled=true;return;}
  chapterSelect.disabled=false;
  Object.keys(bibleData[b]).forEach(ch=>{
    let o=document.createElement('option');
    o.value=ch;o.textContent=`ç¬¬${ch}ç« `;
    chapterSelect.appendChild(o);
  });
});

// é¸ç« ç¯€
chapterSelect.addEventListener('change',()=>{
  const b=bookSelect.value;const ch=chapterSelect.value;
  if(!b||!ch)return;
  verseSelect.innerHTML='<option value="">å…¨éƒ¨ç¶“æ–‡</option>';
  Object.keys(bibleData[b][ch]).forEach(v=>{
    let o=document.createElement('option');
    o.value=v;o.textContent=`ç¬¬${v}ç¯€`;
    verseSelect.appendChild(o);
  });
  verseSelect.disabled=false;
  showChapter();
});

// é¸ç¯€
verseSelect.addEventListener('change',()=>showChapter());

// é¡¯ç¤ºç¶“æ–‡
function showChapter(){
  const b=bookSelect.value;const ch=chapterSelect.value;const v=verseSelect.value;
  if(!b||!ch){bibleContentDiv.textContent="ğŸ“– è«‹é¸æ“‡æ›¸å·å’Œç« ç¯€";return;}
  if(v){
    bibleContentDiv.innerHTML=`<p>${bibleData[b][ch][v]}</p>`;
  }else{
    bibleContentDiv.innerHTML=Object.values(bibleData[b][ch]).map(t=>`<p>${t}</p>`).join('');
  }
  explainButton.disabled=false;
  prevBtn.disabled=!bibleData[b][parseInt(ch)-1];
  nextBtn.disabled=!bibleData[b][parseInt(ch)+1];
}
prevBtn.onclick=()=>{chapterSelect.value=parseInt(chapterSelect.value)-1;verseSelect.value="";showChapter();};
nextBtn.onclick=()=>{chapterSelect.value=parseInt(chapterSelect.value)+1;verseSelect.value="";showChapter();};

// AI è§£é‡‹
explainButton.onclick = async () => {
  const b = bookSelect.value;
  const ch = chapterSelect.value;
  const v = verseSelect.value;
  let passage = bibleContentDiv.innerText;
  if (!b || !ch) return;
  if (passage.length > 4000) passage = passage.substring(0, 4000) + " ...ï¼ˆå…§å®¹å·²æˆªæ–·ï¼‰";

  loading.classList.remove("hidden");
  aiOutputDiv.textContent = "";

  try {
    const res = await fetch("https://api.x.ai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${GROK_API_KEY}`
      },
      body: JSON.stringify({
        model: "grok-3-mini",
        messages: [
          { role: "system", content: "ä½ æ˜¯ä¸€ä½åŸºç£æ•™è–ç¶“è§£ç¶“å°ˆå®¶ï¼Œæœƒæ ¹æ“šåŸºç£æ•™ä¿¡ä»°èˆ‡è–ç¶“çœŸç†æä¾›æ¸…æ™°ã€å¿ æ–¼ç¶“æ–‡çš„è§£é‡‹ã€‚" },
          { role: "user", content: `è«‹ç”¨ä¸­æ–‡ï¼ˆç¹é«”ï¼‰è©³ç´°è§£é‡‹è–ç¶“ ${b} ${v ? `ç¬¬${v}ç¯€` : `ç¬¬${ch}ç« `}ï¼ŒåŒ…å«è§£é‡‹ã€ç¶“æ–‡ä¸»é¡Œã€èƒŒæ™¯è³‡æ–™ã€äº¤å‰å¼•ç”¨ã€å‡ºè™•èˆ‡åæ€å•é¡Œï¼š\n${passage}` }
        ],
        temperature: 0.7
      })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    aiOutputDiv.innerHTML = data.choices?.[0]?.message?.content?.replace(/\n/g,"<br>") 
      || "âš ï¸ AI æ²’æœ‰å›è¦†ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦ã€‚";
  } catch (e) {
    aiOutputDiv.textContent = "âŒ AI è§£é‡‹å¤±æ•—ï¼š" + e.message;
  }
  loading.classList.add("hidden");
};
</script>
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}</script>
</body>
</html>
